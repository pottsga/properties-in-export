/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var w=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var j=(d,a)=>{for(var e in a)w(d,e,{get:a[e],enumerable:!0})},S=(d,a,e,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of v(a))!x.call(d,n)&&n!==e&&w(d,n,{get:()=>a[n],enumerable:!(t=b(a,n))||t.enumerable});return d};var C=d=>S(w({},"__esModule",{value:!0}),d);var A={};j(A,{default:()=>m});module.exports=C(A);var c=require("obsidian"),H={displayProperties:!0,omittedProperties:"",insertAfterHeading:!1},m=class extends c.Plugin{constructor(){super(...arguments);this.currentFile=null;this.originalPrintCallback=null;this.isPrintPatched=!1}async onload(){var l,p;await this.loadSettings(),this.addSettingTab(new k(this.app,this)),this.registerInterval(window.setInterval(()=>console.log("setInterval"),5*60*1e3)),this.registerEvent(this.app.workspace.on("file-open",r=>{this.currentFile=r})),this.currentFile=this.app.workspace.getActiveFile();let e=(l=this.app.commands)==null?void 0:l.commands;if(e){let s=Object.keys(e).filter(o=>/print|pdf/i.test(o));console.log("Properties-on-export: found command ids matching /print|pdf/:",s)}let t=e?e["editor:print"]:void 0,n=e?e["export-pdf"]:void 0,i=e?e["app:export-pdf"]:void 0;t&&!this.isPrintPatched&&(this.originalPrintCallback=(p=t.callback)!=null?p:null,t.callback=async(...r)=>{try{await this.injectRenderedProperties()}catch(o){console.error("Error injecting properties before print",o)}let s;try{return this.originalPrintCallback&&(s=await this.originalPrintCallback.apply(t,r)),s}finally{try{await this.removeInjectedProperties()}catch(o){console.error("Error removing injected properties after print",o)}}},this.isPrintPatched=!0),n&&(console.log("Properties-on-export: patching export-pdf command"),n.callback=async(...r)=>{try{await this.injectRenderedProperties()}catch(s){console.error("inject before export-pdf",s)}try{this.originalPrintCallback&&await this.originalPrintCallback.apply(n,r)}finally{try{await this.removeInjectedProperties()}catch(s){console.error("remove after export-pdf",s)}}}),i&&(console.log("Properties-on-export: patching app:export-pdf command"),i.callback=async(...r)=>{try{await this.injectRenderedProperties()}catch(s){console.error("inject before app:export-pdf",s)}try{this.originalPrintCallback&&await this.originalPrintCallback.apply(i,r)}finally{try{await this.removeInjectedProperties()}catch(s){console.error("remove after app:export-pdf",s)}}}),this.registerDomEvent(window,"beforeprint",async()=>{try{await this.injectRenderedProperties()}catch(r){console.error("Error injecting properties during beforeprint",r)}}),this.registerDomEvent(window,"afterprint",async()=>{try{await this.removeInjectedProperties()}catch(r){console.error("Error removing properties during afterprint",r)}}),this.registerMarkdownPostProcessor((r,s)=>{try{console.log("Properties-on-export: markdown post-processor called");let o=s.sourcePath;if(!o)return;let u=this.app.vault.getAbstractFileByPath(o);if(!u)return;let h=this.app.metadataCache.getFileCache(u);if(!(h!=null&&h.frontmatter)||!this.settings.displayProperties)return;let P=Object.assign({},h.frontmatter);if(delete P.position,r.closest(".dataview"))return;let g=r.closest(".markdown-preview-section");if(g||(g=r),g.querySelector(".export-properties-block"))return;let f=this.getPropertiesHtml(P);if(!f)return;if(this.settings.insertAfterHeading){let y=g.querySelector("h1");y?y.insertAdjacentHTML("afterend",f):g.insertAdjacentHTML("afterbegin",f)}else g.insertAdjacentHTML("afterbegin",f)}catch(o){console.error("Properties-on-export: post-processor failed",o)}})}getPropertiesHtml(e){let t=this.settings.omittedProperties.split(",").map(i=>i.trim()).filter(i=>i.length>0);for(let i of t)delete e[i];if(Object.keys(e).length===0)return null;let n='<div class="export-properties-block" style="margin-bottom:1em;background:#f9f9f9;page-break-inside:avoid;">';n+='<table style="width:100%;">';for(let i of Object.keys(e)){let l=e[i],p=this.valueToHtml(l);n+=`<tr><td style="font-weight:bold;padding:2px 6px;width:25%;">${this.escapeHtml(i)}</td><td style="padding:2px 6px;">${p}</td></tr>`}return n+="</table></div>",n}async injectRenderedProperties(){var s;console.log("Injecting properties for file",(s=this.currentFile)==null?void 0:s.path),console.log("Properties-on-export: injectRenderedProperties called");let e=this.currentFile;if(!e)return;let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter)||!this.settings.displayProperties)return;let n=t.frontmatter,i=Object.assign({},n);delete i.position;let l=this.getPropertiesHtml(i);if(!l){console.log("Properties-on-export: No properties to display after filtering");return}let p=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!p)return;let r=p.contentEl.querySelector(".markdown-preview-section");r&&!r.querySelector(".export-properties-block")&&r.insertAdjacentHTML("afterbegin",l)}async removeInjectedProperties(){console.log("Removing injected properties"),console.log("Properties-on-export: removeInjectedProperties called");let e=this.app.workspace.getActiveViewOfType(c.MarkdownView);if(!e)return;let t=e.contentEl.querySelector(".export-properties-block");t&&t.remove()}escapeHtml(e){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}valueToHtml(e){if(e==null)return"";if(Array.isArray(e))return e.map(i=>this.valueToHtml(i)).join(", ");let t=String(e),n=t.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}):(\d{2})(?::(\d{2}))?$/);if(n){let[,i,l,p]=n,r=parseInt(l,10),s=p,o=r>=12?"PM":"AM";r=r%12,r===0&&(r=12);let u=String(r).padStart(2,"0");return`${this.escapeHtml(i)} ${this.escapeHtml(u+s+o)}`}return t=t.replace(/\[\[([^\]]+)\]\]/g,(i,l)=>`<a class="internal-link" href="#" style="color:var(--text-accent, #388bfd);text-decoration:underline;">${this.escapeHtml(l)}</a>`),t}onunload(){var e;try{let t=(e=this.app.commands)==null?void 0:e.commands,n=t?t["editor:print"]:void 0;n&&this.isPrintPatched&&this.originalPrintCallback&&(n.callback=this.originalPrintCallback)}catch(t){console.error("Failed to restore print command on unload",t)}}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},k=class extends c.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new c.Setting(e).setName("Display properties in exported documents?").setDesc("Whether to include YAML frontmatter properties in the exported documents").addToggle(t=>t.setValue(this.plugin.settings.displayProperties).onChange(async n=>{this.plugin.settings.displayProperties=n,await this.plugin.saveSettings()})),new c.Setting(e).setName("Properties to omit").setDesc("Comma-separated list of property names to exclude from export (case sensitive)").addText(t=>t.setPlaceholder("title,date,tags").setValue(this.plugin.settings.omittedProperties).onChange(async n=>{this.plugin.settings.omittedProperties=n,await this.plugin.saveSettings()})),new c.Setting(e).setName("Insert properties after first heading?").setDesc(`If enabled, the properties block will be inserted after the first top-level heading (#) instead of at the very top. This works well with vaults using Chris Basham's "Alias from heading" plugin.`).addToggle(t=>t.setValue(this.plugin.settings.insertAfterHeading).onChange(async n=>{this.plugin.settings.insertAfterHeading=n,await this.plugin.saveSettings()}))}};
